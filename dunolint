(lang dunolint 1.0)

;; Everything is instrumented

(rule
 (enforce
  (dune
   (instrumentation
    (backend bisect_ppx)))))

;; Test lib naming

(rule
 (cond
  ((path
    (or
     (glob test/**)
     (glob example/**)))
   (enforce
    (dune
     (library
      (and
       (not
        (has_field public_name))
       (has_field inline_tests)
       (package
        (equals volgo-tests))
       (name
        (is_suffix _test)))))))))

;; Configure the ppx_js_style linter

(rule
 (enforce
  (dune
   (lint
    (pps
     (and
      (pp ppx_js_style)
      (flag
       (name -allow-let-operators)
       (param none)
       (applies_to
        (pp ppx_js_style)))
      (flag
       (name -check-doc-comments)
       (param none)
       (applies_to
        (pp ppx_js_style)))))))))

;; Configure ppx flags

(rule
 (cond
  ((dune
    (preprocess
     (pps
      (or
       (pp ppx_sexp_conv)))))
   (enforce
    (dune
     (preprocess
      (pps
       (flag
        (name -unused-code-warnings)
        (param
         (equals force))
        (applies_to driver)))))))))

;; With the exception of one library we made a deliberate effort not to depend
;; on ppx except in tests. Let's enforce this going forward.

(rule
 (cond
  ((path
    (glob src/volgo-base/*))
   return)
  ((path
    (glob src/**))
   (enforce
    (dune
     (preprocess no_preprocessing))))))
