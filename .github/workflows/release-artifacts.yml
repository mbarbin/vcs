name: Build and Upload Release Artifacts

on:
  push:
    tags:
      - "*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag to build artifacts for"
        required: true

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  build-and-upload:
    name: Build and Upload Release Artifacts
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    env:
      OPAM_DESTDIR: ${{ github.workspace }}/opam-destdir

    defaults:
      run:
        shell: bash

    steps:
      - name: Set TAG_NAME variable
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            # workflow_dispatch case
            echo "TAG_NAME=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            # push tags case
            echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV
          else
            echo "::error::Could not determine tag name"
            exit 1
          fi

      - name: Wait for release to be created
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          for i in {1..30}; do
            if gh release view "$TAG_NAME" --repo "$GITHUB_REPOSITORY" &>/dev/null; then
              echo "Release found for tag $TAG_NAME"
              exit 0
            fi
            echo "Waiting for release... (attempt $i/30)"
            sleep 10
          done
          echo "::error::Release for tag $TAG_NAME was never created after 5 minutes"
          exit 1

      - name: Checkout Code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ env.TAG_NAME }}

      - name: Setup OCaml
        uses: ocaml/setup-ocaml@dec6499fef64fc5d7ed43d43a87251b7b1c306f5 # v3.4.8
        with:
          ocaml-compiler: 5.3.x
          opam-repositories: |
            default: https://github.com/ocaml/opam-repository.git
            mbarbin: https://github.com/mbarbin/opam-repository.git
      #     alpha:   https://github.com/kit-ty-kate/opam-alpha-repository.git
      #     janestreet-bleeding: https://github.com/janestreet/opam-repository.git
      #     janestreet-bleeding-external: https://github.com/janestreet/opam-repository.git#external-packages

      - name: Build Artifacts
        run: |
          mkdir -p "$OPAM_DESTDIR"
          opam install ./volgo-vcs.opam --destdir="$OPAM_DESTDIR"
        env:
          OPAMYES: "true"

      - name: Prepare Artifacts
        run: |
          os=$(echo "${{ runner.os }}" | tr '[:upper:]' '[:lower:]')
          arch=$(uname -m)
          bin_name="${{ github.workspace }}/volgo-vcs-$TAG_NAME-$os-$arch"
          cp "$OPAM_DESTDIR/bin/volgo-vcs" $bin_name
          echo "BIN_NAME=$bin_name" >> $GITHUB_ENV

      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
        with:
          subject-path: "${{ env.BIN_NAME }}"

      - name: Upload Platform-Specific Binary
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ env.TAG_NAME }}
          draft: true
          files: |
            ${{ env.BIN_NAME }}
